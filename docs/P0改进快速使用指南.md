# P0 改进 - 快速使用指南

## 🚀 立即开始

### 1. 环境配置

复制并修改环境变量文件：

```bash
cp .env.example .env
```

编辑 `.env` 文件，设置日志级别：

```env
# 日志级别：DEBUG | INFO | WARN | ERROR | SILENT
NEXT_PUBLIC_LOG_LEVEL=DEBUG  # 开发环境推荐 DEBUG
```

### 2. 启动开发服务器

```bash
npm run dev
```

服务器启动后，你会看到新的日志输出：

```
ℹ️  [INFO] 🔧 应用启动：验证环境变量...
✅ [SUCCESS] 环境变量加载完成
```

---

## 📝 使用新的日志系统

### 在 Server-Side 代码中

```javascript
import { logger } from '@/lib/core/logger'

// API 路由
export default async function handler(req, res) {
  logger.info('API 被调用', { method: req.method, url: req.url })

  try {
    // 业务逻辑
    const result = await doSomething()
    logger.success('操作成功', { result })
    res.json({ success: true })
  } catch (error) {
    logger.error('操作失败', error, { context: 'handler' })
    res.status(500).json({ error: 'Internal error' })
  }
}
```

### 在 Client-Side 组件中

```javascript
// 使用动态导入避免增加包大小
useEffect(() => {
  import('@/lib/core/logger').then(({ logger }) => {
    logger.info('组件已挂载', { component: 'MyComponent' })
  })
}, [])

// 或在错误处理中
try {
  // 某些操作
} catch (error) {
  import('@/lib/core/logger').then(({ logger }) => {
    logger.error('客户端错误', error)
  })
}
```

### 日志级别说明

```javascript
logger.debug('调试信息', { data }) // 仅开发环境
logger.info('一般信息', { data }) // 所有环境
logger.warn('警告信息', { data }) // 所有环境
logger.error('错误信息', error, { data }) // 所有环境 + Sentry
logger.success('成功信息', { data }) // 所有环境
logger.perf('性能指标', 123, { data }) // 仅开发环境
logger.api('POST', '/api/test', 200, { data }) // API 日志
```

---

## 🔧 创建新的 API 路由

### 基础示例

```javascript
// pages/api/my-endpoint.js
import { apiHandler, validateBody } from '@/lib/core/api-handler'
import { ValidationError } from '@/lib/core/api-errors'
import { logger } from '@/lib/core/logger'

const myHandler = async (req, res) => {
  const { name, email } = req.body

  // 验证必需字段
  validateBody(req.body, ['name', 'email'])

  // 自定义验证
  if (!email.includes('@')) {
    throw new ValidationError('Invalid email format')
  }

  // 业务逻辑
  logger.info('处理用户注册', { name, email: email.slice(0, 3) + '***' })

  // 返回结果
  return {
    statusCode: 201,
    data: { userId: 123 },
    message: 'User created successfully',
  }
}

// 导出包装后的处理器
export default apiHandler(myHandler, {
  methods: ['POST'], // 只允许 POST 请求
})
```

### 高级示例（带错误处理）

```javascript
import { apiHandler } from '@/lib/core/api-handler'
import { ValidationError, ExternalServiceError, ConflictError } from '@/lib/core/api-errors'
import { logger } from '@/lib/core/logger'

const advancedHandler = async (req, res) => {
  const { email } = req.body

  try {
    // 调用外部 API
    const response = await fetch('https://api.example.com/subscribe', {
      method: 'POST',
      body: JSON.stringify({ email }),
      headers: { 'Content-Type': 'application/json' },
    })

    if (!response.ok) {
      // 处理不同的错误状态
      if (response.status === 409) {
        throw new ConflictError('Email already subscribed')
      }
      throw new Error(`API error: ${response.status}`)
    }

    const data = await response.json()

    logger.success('订阅成功', {
      email: email.slice(0, 3) + '***',
    })

    return {
      data,
      message: 'Successfully subscribed',
    }
  } catch (error) {
    // 外部服务错误
    if (error instanceof ConflictError) {
      throw error // 直接抛出已知错误
    }

    // 包装未知错误
    logger.error('外部 API 调用失败', error)
    throw new ExternalServiceError('SubscriptionService', error)
  }
}

export default apiHandler(advancedHandler, { methods: ['POST'] })
```

---

## 🌍 使用环境变量

### 基础访问

```javascript
import { env } from '@/lib/config/env'

// 环境判断
if (env.isDevelopment) {
  console.log('开发模式')
}

// Newsletter 配置
const { provider, mailchimp } = env.newsletter
if (provider === 'mailchimp') {
  const { apiKey, server, audienceId } = mailchimp
  // 使用配置
}

// 评论系统配置
const { giscus } = env.comment
```

### 高级用法

```javascript
import { hasEnv, requireEnv, getEnvVar } from '@/lib/config/env'

// 检查环境变量是否存在
if (hasEnv('MAILCHIMP_API_KEY')) {
  // 使用 Mailchimp
} else {
  // 使用备选方案
}

// 必需的环境变量（不存在会抛出错误）
const apiKey = requireEnv('MAILCHIMP_API_KEY')

// 带默认值的访问
const timeout = getEnvVar('API_TIMEOUT', 5000)
```

### 在 API 路由中使用

```javascript
import { env } from '@/lib/config/env'
import { ConfigurationError } from '@/lib/core/api-errors'

const handler = async (req, res) => {
  const { apiKey, server } = env.newsletter.mailchimp

  // 检查配置
  if (!apiKey || !server) {
    throw new ConfigurationError('Mailchimp not configured', {
      required: ['MAILCHIMP_API_KEY', 'MAILCHIMP_API_SERVER'],
    })
  }

  // 使用配置
  // ...
}
```

---

## 🧪 测试新系统

### 运行测试脚本

```bash
node scripts/test-p0-improvements.js
```

你应该看到：

```
✅ 所有核心系统功能正常！
```

### 测试 Newsletter API

使用 curl 或 Postman 测试：

```bash
# 测试 Mailchimp API
curl -X POST http://localhost:3000/api/mailchimp \
  -H "Content-Type: application/json" \
  -d '{"email":"test@example.com"}'
```

**成功响应**：

```json
{
  "success": true,
  "message": "Successfully subscribed to newsletter",
  "data": {
    "subscribed": true
  },
  "timestamp": "2025-12-11T15:54:02.518Z"
}
```

**错误响应**：

```json
{
  "success": false,
  "error": {
    "message": "Invalid email address format",
    "code": "VALIDATION_ERROR"
  },
  "timestamp": "2025-12-11T15:54:02.518Z"
}
```

### 测试环境变量状态

```bash
curl http://localhost:3000/api/env-status
```

---

## 📊 查看日志输出

### 开发环境（控制台）

启动开发服务器后，日志会以可读格式输出：

```
ℹ️  [INFO] 应用启动：验证环境变量...
✅ [SUCCESS] 环境变量加载完成
🟢 [INFO] GET /api/env-status - 200 { duration: 15 }
```

### 生产环境（JSON）

生产环境的日志是 JSON 格式，便于日志聚合工具解析：

```json
{
  "timestamp": "2025-12-11T15:54:02.514Z",
  "level": "INFO",
  "context": "[Server]",
  "message": "API 被调用"
}
```

---

## 🔍 调试技巧

### 1. 调整日志级别

在 `.env` 文件中：

```env
# 查看更多详细信息
NEXT_PUBLIC_LOG_LEVEL=DEBUG

# 只看重要信息
NEXT_PUBLIC_LOG_LEVEL=INFO

# 只看错误
NEXT_PUBLIC_LOG_LEVEL=ERROR
```

### 2. 查看详细错误信息

开发环境会显示完整的错误堆栈：

```json
{
  "success": false,
  "error": {
    "message": "External service error: Mailchimp",
    "code": "EXTERNAL_SERVICE_ERROR",
    "stack": "Error: ...\n    at ...", // 仅开发环境
    "details": {
      "service": "Mailchimp",
      "originalError": "Connection timeout"
    }
  }
}
```

### 3. API 性能监控

所有 API 请求自动记录响应时间：

```
🟢 [INFO] POST /api/mailchimp - 201 { duration: 150 }
```

---

## ⚡ 性能优化建议

### 1. 客户端日志使用动态导入

```javascript
// ✅ 推荐
import('@/lib/core/logger').then(({ logger }) => {
  logger.info('Message')
})

// ❌ 避免在客户端组件顶层导入
import { logger } from '@/lib/core/logger' // 会增加包大小
```

### 2. 生产环境减少日志

```javascript
// 只在开发环境记录详细日志
if (env.isDevelopment) {
  logger.debug('详细调试信息', { data })
}
```

### 3. 避免记录敏感信息

```javascript
// ✅ 好的做法
logger.info('用户登录', {
  email: email.slice(0, 3) + '***',
  userId: user.id,
})

// ❌ 避免
logger.info('用户登录', {
  email: email, // 完整邮箱
  password: password, // 密码！
})
```

---

## 🆘 常见问题

### Q: 日志太多了，如何减少？

**A**: 修改 `.env` 中的 `NEXT_PUBLIC_LOG_LEVEL`：

```env
NEXT_PUBLIC_LOG_LEVEL=WARN  # 只显示警告和错误
```

### Q: API 返回 500 错误但没有详细信息？

**A**: 生产环境不会暴露详细错误。在开发环境测试，或检查服务器日志。

### Q: 环境变量验证失败？

**A**: 检查 `.env` 文件配置，确保必需的字段都已设置。运行：

```bash
node scripts/test-p0-improvements.js
```

### Q: Sentry 没有收到错误报告？

**A**: 确保在 `.env` 中配置了：

```env
NEXT_PUBLIC_SENTRY_DSN=your_dsn_here
```

---

## 📚 进一步学习

### 相关文件

- `lib/core/logger.js` - 日志系统实现
- `lib/core/api-handler.js` - API 包装器
- `lib/core/api-errors.js` - 错误类型定义
- `lib/config/env.js` - 环境变量访问

### 文档

- `docs/P0改进完成报告.md` - 完整改进报告
- `.env.example` - 环境变量模板

---

## 💡 最佳实践

1. **始终使用 logger 而不是 console.log**
2. **API 路由必须使用 apiHandler 包装**
3. **使用具体的错误类型（ValidationError, ConflictError 等）**
4. **环境变量通过 env 对象访问**
5. **客户端日志使用动态导入**
6. **不要记录敏感信息**
7. **生产环境使用 INFO 或 WARN 级别**

---

需要帮助？查看完整报告：`docs/P0改进完成报告.md`
